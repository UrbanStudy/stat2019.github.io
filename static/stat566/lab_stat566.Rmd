---
title: ""
author: ''
date: ""
output: html_document
---

#  {.tabset .tabset-fade .tabset-pills}


## lab1 

 - general Factorial Design and obtain Normal Probability plot of effects

Install and load FrF2 package 

FrF2 stands for Fractional Factor 2-level design which will be learned later 

Here we use 4 factors with total of 16 observations

```{r echo=TRUE, message=FALSE, collapse=TRUE, out.width='25%', results='hold'}
library(FrF2)
lab1_design <- FrF2(nruns=16, nfactors=4, randomize = FALSE)
lab1_response <- c(1.92, 11.28, 1.09, 5.75, 2.13, 9.53, 1.03, 5.35, 1.60, 11.73, 1.16, 4.68, 2.16, 9.11, 1.07, 5.30)
lab1_table<- add.response(lab1_design, response =lab1_response)
lab1_table
```
Check the design. Note that the output is in the standard order of treatment combinations

Here the data are effect, should not be used as response variable.

```{r echo=TRUE, message=FALSE, collapse=TRUE, out.width='25%', results='hold'}
lab1_model <-lm( lab1_response ~ A * B * C * D, data =lab1_table) 
lab1_effects <- coef(lab1_model)[2:16]
library(daewr) 
halfnorm(lab1_effects, names(lab1_effects), alpha = 0.05)
library(AlgDesign)
gen.factorial(levels = 2, nVars = 5, varNames=c("A","B","C","D","E"))
library(gghalfnorm)
gghalfnorm(x =lab1_effects,labs =names(lab1_effects), nlab = 3)+ theme_light()

qqnorm(lab1_effects, pch=16, ylab="Estimated Effects", xlab="Normal Scores", main="Normal Probability Plot of Treatment Effects")
qqline(lab1_effects)
```

```{r echo=TRUE, message=FALSE, collapse=TRUE, out.width='30%', results='hold'}
# hw1_3 <- tribble(~factors, ~effect, "A",76.95, "B", -67.52,"C",-7.84, "D",-18.73, "AB", -51.32, "AC", 11.69, "AD",9.78, "BC", 20.78, "BD", 14.74, "CD", 1.27, "ABC", -2.82, "ABD", -6.5, "ACD",10.2, "BCD",-7.98, "ABCD",-6.25)

factors <-c("A","B","C","D","AB","AC","AD","BC","BD","CD","ABC","ABD", "ACD","BCD","ABCD")
effect <- c(76.95,-67.52,-7.84,-18.73,-51.32,11.69,9.78,20.78,14.74,1.27,-2.82,-6.5,10.2,-7.98,-6.25)
hw1_3 <- data.frame(factors,effect)
library(dplyr)
library(ggplot2)
hw1_3_qq<-ggplot(hw1_3, aes(sample = effect),label=factors) + stat_qq()
hw1_3_new<-ggplot_build(hw1_3_qq)$data[[1]]
#### hw1_3_new$name<-hw1_3_new$name[order(hw1_3$effect)]
hw1_3_new%>%mutate(name=hw1_3$factors[order(hw1_3$effect)])%>%
ggplot(aes(theoretical,sample,label=name))+geom_text()+stat_qq_line(aes(sample = y), line.p = c(0.25, 0.75),linetype=4, col = "red")+ theme_light()
library(gghalfnorm)
gghalfnorm(x = hw1_3$effect,labs = as.character(hw1_3$factors), nlab = 3)+ theme_light()
library(daewr) 
halfnorm(hw1_3$effect, names(as.character(hw1_3$factors)), alpha = 0.05)
```


## lab2

 - Confounded Factorial Design Exercise 6.22

This experiment was redesigned so that AC and BD interaction effect (and hence ABCD effect) are confounded with 4 blocks.

Install and load FrF2 package 

Use FrF2 function as shown below to create the deign 

blocks option is used to indicate confounding factor effects. Here AD and BC are confounded 

nruns is for the number of runs, must be a power of 2

```{r}
library(FrF2)
lab2_des <- FrF2(nruns=16, nfactors = 4, blocks = c("AD", "BC"), randomize = FALSE)
lab2_des
```

Note the Blocks are sorted so that both negative (AD-, Bc-), (AD+, BC-), (Ad-,BC+), and both positive

Change the order of AD and BC in the FrF2 function above and see the difference in the output design

If the given data file is sorted by Block, then sort the above design accordingly

If the given data file is sorted by standard order of trt combinations, then sort the above design accordingly 
Sort Design by Block and each factor to get standard order within each block

```{r}
lab2_des_sort1 <- lab2_des[order(lab2_des$Blocks, lab2_des$D ,lab2_des$C ,lab2_des$B,lab2_des$A ),]
lab2_des_sort1
```

Sort Design by each factor to get standard order

```{r}
Design_Sort2 <- lab2_des[order(lab2_des$D ,lab2_des$C ,lab2_des$B,lab2_des$A),]
Design_Sort2
```

Import the Example Excel file

```{r}
lab2_example <- readxl::read_xlsx("Example.xlsx")
```
This data file is in the standard order

Therefore, use the Design_Sort2 to combine response
```{r}
lab2_obs <- cbind(Design_Sort2,lab2_example)
lab2_obs
```

Note the Block numbers are different in the design and the actual data file 

Therefore, use Block numbers in the actual data file for the analysis

First, change it to a factor

```{r}
lab2_obs$Blk <-as.factor(lab2_obs$Block)

lab2_fit1 <- aov(UEC ~ Blk + A * B * C * D, data =lab2_obs)
lab2_effects <- coef(lab2_fit1)
lab2_effects
lab2_l <- length(lab2_effects)
```

Selects the non-block effects that do not have the value of NA 

```{r echo=TRUE, message=FALSE, collapse=TRUE, out.width='25%', results='hold'}
lab2_effects <-lab2_effects[5:lab2_l]
#lab2_effects <-lab2_effects[!is.na(d)]
qqnorm(lab2_effects, pch=16) 
qqline(lab2_effects)
library(ggplot2)
library(gghalfnorm)
gghalfnorm(x =lab2_effects,labs =names(lab2_effects), nlab=4)+ theme_light()
library(daewr) 
halfnorm(lab2_effects, names(lab2_effects), alpha = 0.15)
lab2_fit2<- aov(UEC ~ Blk + A + C + D + A:C, data = lab2_obs)
summary(lab2_fit2)
plot(lab2_fit2, pch=16) 
```
